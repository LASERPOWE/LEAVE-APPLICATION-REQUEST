<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Application Form</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #f0f0f0;
    }
    video.bg-video {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -1;
      object-fit: cover;
    }
    .form-container {
      max-width: 600px;
      margin: 5% auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #28a745;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
    }
    #authOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <video autoplay muted loop class="bg-video">
    <source src="background.mp4" type="video/mp4">
  </video>

  <div id="authOverlay">
    <div id="g_id_onload"
         data-client_id="819720991947-gqobkscn6pt2uhik6lv2pq5ijjuj3ttc.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <div class="loading-overlay" id="loading">Loading...</div>

  <div class="form-container" style="display:none;">
    <form id="leaveForm">
      <label for="emp_code">EMP CODE:</label>
      <input type="text" id="emp_code" name="emp_code" required />

      <label for="emp_name">EMP NAME:</label>
      <select id="emp_name" name="emp_name" required>
        <option value="">--Select Employee--</option>
      </select>

      <label for="hod">HOD:</label>
      <input type="text" id="hod" name="hod" readonly />

      <label for="desig_name">DESIGNATION:</label>
      <input type="text" id="desig_name" name="desig_name" readonly />

      <label for="dept_name">DEPARTMENT:</label>
      <input type="text" id="dept_name" name="dept_name" readonly />

      <label for="leave_type">LEAVE TYPE:</label>
      <select id="leave_type" name="leave_type" required>
        <option value="CL">CL</option>
        <option value="SL">SL</option>
        <option value="COFF">COFF</option>
      </select>

      <label for="from_date">FROM DATE:</label>
      <input type="date" id="from_date" name="from_date" required />

      <label for="to_date">TO DATE:</label>
      <input type="date" id="to_date" name="to_date" required />

      <label for="reason">REASON:</label>
      <input type="text" id="reason" name="reason" required />

      <label for="leave_count">TAKEN LEAVE COUNT:</label>
      <input type="number" id="leave_count" name="leave_count" readonly />

      <input type="hidden" id="hod_mail" name="hod_mail" />
      <input type="hidden" id="user_mail" name="user_mail" />

      <button type="submit">Submit</button>
    </form>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwo_9o4UxgcQfFxQtEHPb9351an-SoYQQ3d2CfeWh4v0Qr-BHHXzjtp9ccEGULNC_AfNw/exec';
    const form = document.getElementById("leaveForm");
    const empNameSelect = document.getElementById("emp_name");
    const loading = document.getElementById("loading");
    const authOverlay = document.getElementById("authOverlay");

    let matchedEmployees = [];

    function handleCredentialResponse(response) {
      const data = JSON.parse(atob(response.credential.split('.')[1]));
      const email = data.email;
      if (email) {
        localStorage.setItem("user_mail", email);
        document.getElementById("user_mail").value = email;
        document.querySelector(".form-container").style.display = "block";
        authOverlay.style.display = "none";
      }
    }

    window.onload = () => {
      const email = localStorage.getItem("user_mail");
      if (email) {
        document.getElementById("user_mail").value = email;
        document.querySelector(".form-container").style.display = "block";
        authOverlay.style.display = "none";
      }
    };

    document.getElementById("emp_code").addEventListener("blur", () => {
      const code = form.emp_code.value.trim();
      if (!code) return;
      loading.style.display = "flex";

      fetch(`${scriptURL}?emp_code=${code}`)
        .then(res => res.json())
        .then(data => {
          loading.style.display = "none";
          empNameSelect.innerHTML = '<option value="">--Select Employee--</option>';
          matchedEmployees = Array.isArray(data.employees) ? data.employees : [];

          matchedEmployees.forEach((emp, i) => {
            const opt = document.createElement("option");
            opt.value = emp.emp_name;
            opt.textContent = emp.emp_name;
            empNameSelect.appendChild(opt);
          });

          if (matchedEmployees.length === 1) {
            empNameSelect.value = matchedEmployees[0].emp_name;
            fillEmployeeData(matchedEmployees[0]);
          }
        })
        .catch(err => {
          loading.style.display = "none";
          alert("Error fetching employee data.");
        });
    });

    empNameSelect.addEventListener("change", () => {
      const selected = matchedEmployees.find(e => e.emp_name === empNameSelect.value);
      if (selected) fillEmployeeData(selected);
    });

    function fillEmployeeData(emp) {
      form.hod.value = emp.hod;
      form.desig_name.value = emp.desig_name;
      form.dept_name.value = emp.dept_name;
      form.hod_mail.value = emp.hod_mail;
    }

    function calculateLeaveDays() {
      const from = new Date(form.from_date.value);
      const to = new Date(form.to_date.value);
      if (!isNaN(from) && !isNaN(to)) {
        if (to < from) {
          alert("TO DATE cannot be before FROM DATE.");
          form.to_date.value = "";
          form.leave_count.value = "";
        } else {
          const diff = (to - from) / (1000 * 3600 * 24) + 1;
          form.leave_count.value = diff;
        }
      }
    }

    form.from_date.addEventListener("change", calculateLeaveDays);
    form.to_date.addEventListener("change", calculateLeaveDays);

    form.addEventListener("submit", e => {
      e.preventDefault();
      loading.style.display = "flex";

      const formData = new FormData(form);
      const jsonData = Object.fromEntries(formData.entries());

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(jsonData),
        headers: { "Content-Type": "application/json" },
      })
        .then(response => {
          loading.style.display = "none";
          if (response.ok) {
            alert("Leave request submitted successfully.");
            form.reset();
            empNameSelect.innerHTML = '<option value="">--Select Employee--</option>';
          } else {
            alert("Submission failed.");
          }
        })
        .catch(err => {
          loading.style.display = "none";
          alert("Error submitting form.");
        });
    });
  </script>
</body>
</html>
