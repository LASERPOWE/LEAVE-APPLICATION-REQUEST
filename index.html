<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Application</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to right, #dfe9f3 0%, white 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
    }
    button:hover {
      background-color: #218838;
    }
    .spinner {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      display: none;
    }
    #confirmationModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      max-width: 300px;
    }
    .modal-content button {
      width: 45%;
      margin: 5px;
    }
  </style>
</head>
<body>
  <!-- Spinner -->
  <div id="spinner" class="spinner">ðŸ”„ Logging you in...</div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal">
    <div class="modal-content">
      <p>Are you sure you want to submit the leave application?</p>
      <button onclick="submitForm()">Yes</button>
      <button onclick="hideModal()">Cancel</button>
    </div>
  </div>

  <!-- Main Form Container -->
  <div class="container">
    <h2>Leave Application</h2>

    <!-- Google Sign-In -->
    <div id="g_id_signin"></div>
    <p id="welcome-msg" style="text-align:center; margin-top:10px;"></p>

    <form id="leaveForm">
      <label>EMP CODE</label>
      <input type="text" id="emp_code" required onblur="fetchEmployeeData()">

      <label>EMP NAME</label>
      <input type="text" id="emp_name" readonly>

      <label>HOD</label>
      <input type="text" id="hod" readonly>

      <label>DESIG NAME</label>
      <input type="text" id="desig_name" readonly>

      <label>DEPT NAME</label>
      <input type="text" id="dept_name" readonly>

      <label>LEAVE TYPE</label>
      <select id="leave_type" required>
        <option value="">Select</option>
        <option value="CL">CL</option>
        <option value="SL">SL</option>
        <option value="COFF">COFF</option>
      </select>

      <label>FROM DATE</label>
      <input type="date" id="from_date" required onchange="calculateLeaveCount()">

      <label>TO DATE</label>
      <input type="date" id="to_date" required onchange="calculateLeaveCount()">

      <label>REASON</label>
      <textarea id="reason" rows="2" required></textarea>

      <label>TAKEN LEAVE COUNT</label>
      <input type="number" id="leave_count" readonly>

      <label>HOD MAIL</label>
      <input type="email" id="hod_mail" readonly>

      <label>USER MAIL</label>
      <input type="email" id="user_mail" readonly required>

      <button type="button" onclick="showModal()">Submit</button>
    </form>
  </div>

  <script>
    const spinner = document.getElementById("spinner");
    const welcomeMsg = document.getElementById("welcome-msg");

    spinner.style.display = "flex"; // Show loader initially

    function handleCredentialResponse(response) {
      spinner.style.display = "none";
      const data = parseJwt(response.credential);
      document.getElementById("user_mail").value = data.email;
      welcomeMsg.innerHTML = `Welcome, <strong>${data.name}</strong>`;
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      ).join(''));
      return JSON.parse(jsonPayload);
    }

    window.onload = () => {
      google.accounts.id.initialize({
        client_id: "995677134206-i3n2k43cvsr48ngjb6t69s7tsr0sivpj.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        auto_select: true
      });
      google.accounts.id.renderButton(
        document.getElementById("g_id_signin"),
        { theme: "outline", size: "large" }
      );
      google.accounts.id.prompt();
    };

    function fetchEmployeeData() {
      const empCode = document.getElementById("emp_code").value.trim();
      if (!empCode) return;

      spinner.style.display = "flex";
      const url = `https://script.google.com/macros/s/AKfycbwo_9o4UxgcQfFxQtEHPb9351an-SoYQQ3d2CfeWh4v0Qr-BHHXzjtp9ccEGULNC_AfNw/exec?emp_code=${empCode}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          spinner.style.display = "none";
          document.getElementById("emp_name").value = data.emp_name || "";
          document.getElementById("hod").value = data.hod || "";
          document.getElementById("desig_name").value = data.desig_name || "";
          document.getElementById("dept_name").value = data.dept_name || "";
          document.getElementById("hod_mail").value = data.hod_mail || "";
        })
        .catch(err => {
          spinner.style.display = "none";
          alert("Error fetching employee data.");
        });
    }

    function calculateLeaveCount() {
      const from = new Date(document.getElementById("from_date").value);
      const to = new Date(document.getElementById("to_date").value);
      if (to >= from) {
        const diff = (to - from) / (1000 * 60 * 60 * 24) + 1;
        document.getElementById("leave_count").value = diff;
      } else {
        document.getElementById("leave_count").value = 0;
      }
    }

    function showModal() {
      document.getElementById("confirmationModal").style.display = "flex";
    }

    function hideModal() {
      document.getElementById("confirmationModal").style.display = "none";
    }

    function submitForm() {
      hideModal();
      const form = document.getElementById("leaveForm");
      const data = {
        emp_code: form.emp_code.value,
        emp_name: form.emp_name.value,
        hod: form.hod.value,
        desig_name: form.desig_name.value,
        dept_name: form.dept_name.value,
        leave_type: form.leave_type.value,
        from_date: form.from_date.value,
        to_date: form.to_date.value,
        reason: form.reason.value,
        leave_count: Number(form.leave_count.value),
        hod_mail: form.hod_mail.value,
        user_mail: form.user_mail.value,
      };

      spinner.style.display = "flex";
      fetch("https://script.google.com/macros/s/AKfycbwo_9o4UxgcQfFxQtEHPb9351an-SoYQQ3d2CfeWh4v0Qr-BHHXzjtp9ccEGULNC_AfNw/exec", {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      }).then(() => {
        spinner.style.display = "none";
        alert("Leave application submitted!");
        form.reset();
        document.getElementById("user_mail").value = data.user_mail;
      }).catch(() => {
        spinner.style.display = "none";
        alert("Submission failed!");
      });
    }
  </script>
</body>
</html>
