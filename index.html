<!DOCTYPE html>
<html>
<head>
  <title>Leave Form</title>
  <meta charset="UTF-8">
  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyrSa9M0pfx6FHicGX1cdDve5CikViUDQnnL7lcnbjopbm5WqiuQ1rSfdsjPsGplijW/exec";

    async function fetchEmployeeData() {
      const empCode = document.getElementById("emp_code").value.trim();
      if (!empCode) return;

      try {
        const res = await fetch(`${API_BASE}?emp_code=${empCode}`);
        const data = await res.json();
        if (data.found && data.employees.length > 0) {
          const emp = data.employees[0];
          document.getElementById("emp_name").value = emp.emp_name;
          document.getElementById("hod").value = emp.hod;
          document.getElementById("design_name").value = emp.desig_name;
          document.getElementById("dept_name").value = emp.dept_name;
          document.getElementById("hod_mail").value = emp.hod_mail;
        } else {
          alert("Employee not found");
        }
      } catch (err) {
        alert("Failed to fetch employee data.");
      }
    }

    function calculateLeaveCount() {
      const from = new Date(document.getElementById("from_date").value);
      const to = new Date(document.getElementById("to_date").value);

      if (to < from) {
        alert("To Date cannot be earlier than From Date.");
        document.getElementById("to_date").value = "";
        document.getElementById("leave_count").value = "";
        return;
      }

      const diff = (to - from) / (1000 * 60 * 60 * 24) + 1;
      document.getElementById("leave_count").value = diff;
    }

    async function handleSubmit(event) {
      event.preventDefault();

      const payload = {
        emp_code: document.getElementById("emp_code").value,
        emp_name: document.getElementById("emp_name").value,
        hod: document.getElementById("hod").value,
        design_name: document.getElementById("design_name").value,
        dept_name: document.getElementById("dept_name").value,
        leave_type: document.getElementById("leave_type").value,
        from_date: document.getElementById("from_date").value,
        to_date: document.getElementById("to_date").value,
        reason: document.getElementById("reason").value,
        leave_count: document.getElementById("leave_count").value,
        hod_mail: document.getElementById("hod_mail").value,
        user_mail: document.getElementById("user_mail").value
      };

      try {
        const res = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (text === "Success") {
          alert("Leave request submitted successfully!");
          document.getElementById("leave-form").reset();
        } else {
          alert("Error submitting form: " + text);
        }
      } catch (err) {
        alert("Failed to submit form.");
      }
    }
  </script>
</head>
<body>
  <h2>Leave Application Form</h2>
  <form id="leave-form" onsubmit="handleSubmit(event)">
    <label>Employee Code: <input type="text" id="emp_code" name="emp_code" required onblur="fetchEmployeeData()"></label><br>
    <label>Employee Name: <input type="text" id="emp_name" disabled></label><br>
    <label>HOD: <input type="text" id="hod" disabled></label><br>
    <label>Designation: <input type="text" id="design_name" disabled></label><br>
    <label>Department: <input type="text" id="dept_name" disabled></label><br>
    <label>Leave Type:
      <select id="leave_type" required>
        <option value="CL">CL</option>
        <option value="SL">SL</option>
        <option value="COFF">COFF</option>
      </select>
    </label><br>
    <label>From Date: <input type="date" id="from_date" required onchange="calculateLeaveCount()"></label><br>
    <label>To Date: <input type="date" id="to_date" required onchange="calculateLeaveCount()"></label><br>
    <label>Reason: <input type="text" id="reason" required></label><br>
    <label>Leave Count: <input type="number" id="leave_count" readonly></label><br>
    <label>HOD Email: <input type="email" id="hod_mail" required></label><br>
    <label>Your Email: <input type="email" id="user_mail" required></label><br>
    <button type="submit">Submit</button>
  </form>
</body>
</html>
