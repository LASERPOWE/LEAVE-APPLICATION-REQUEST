<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Leave Application Form</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>/* same CSS as before */</style>
</head>
<body>

<video autoplay muted loop id="bg-video">
  <source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4">
</video>

<div class="form-container">
  <h2>Leave Application Form</h2>
  <div class="balance-info">CL: <span id="cl_balance">‑</span> | SL: <span id="sl_balance">‑</span> | COFF: <span id="coff_balance">‑</span> | Total: <span id="total_balance">‑</span></div>
  <form id="leaveForm">
    <!-- all your form fields -->
    <label>USER MAIL: <input type="email" id="user_mail" name="user_mail" readonly required></label>
    <p id="error"></p>
    <button id="submitBtn" type="submit">Submit</button>
  </form>
</div>

<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
<div class="modal" id="confirmationModal"><div class="modal-content">
  <p>Are you sure you want to submit this leave request?</p>
  <button id="confirmYes">Yes</button>
  <button id="confirmNo">Cancel</button>
</div></div>

<script>
  const scriptURL = 'YOUR_APP_SCRIPT_URL';
  const form = document.getElementById("leaveForm"),
        modal = document.getElementById("confirmationModal"),
        loading = document.getElementById("loadingOverlay"),
        error = document.getElementById("error"),
        submitBtn = document.getElementById("submitBtn");

  // GOOGLE SIGN‑IN INIT
  window.onload = () => {
    google.accounts.id.initialize({
      client_id: 'YOUR_GOOGLE_CLIENT_ID',
      callback: credentialResponse => {
        // Send credentialResponse.credential to verify and decode email...
        const payload = JSON.parse(atob(credentialResponse.credential.split('.')[1]));
        document.getElementById("user_mail").value = payload.email;
      }
    });
    google.accounts.id.prompt();
  };

  // FETCH EMPLOYEE & BALANCE
  document.getElementById("emp_code").onchange = function(){
    const val = this.value.trim(); if(!val) return;
    loading.style.display = "flex";
    fetch(`${scriptURL}?emp_code=${val}`)
      .then(r=>r.json()).then(data=>{
        loading.style.display="none";
        if(data.found){
          const emp = data.employees[0];
          ["emp_name","hod","design_name","dept_name","hod_mail"].forEach(k=>document.getElementById(k).value = emp[k]||"");
          ["cl","sl","coff","total_leave"].forEach(k=>document.getElementById(k+"_balance").innerText = emp[k]||0);
          form.dataset.cl=emp.cl||0; form.dataset.sl=emp.sl||0; form.dataset.coff=emp.coff||0;
        } else alert("Employee not found");
      }).catch(e=>{loading.style.display="none"; alert("Error: "+e.message)});
  };

  // LEAVE CALCULATION & VALIDATION
  ["from_date","to_date","leave_type"].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=> {
      const from=new Date(form.from_date.value), to=new Date(form.to_date.value), lt=form.leave_type.value;
      if(to<from){error.innerText="TO DATE cannot be before FROM DATE"; form.taken_leave_count.value=""; return;}
      const days = Math.floor((to-from)/(1000*60*60*24))+1;
      form.taken_leave_count.value=days;
      const bal = parseFloat(form.dataset[lt.toLowerCase()]||0);
      error.innerText = (lt && days>bal) ? `Insufficient ${lt} balance (${bal})` : "";
    });
  });

  // SUBMIT → POPUP
  form.onsubmit = e=>{ e.preventDefault(); error.innerText?alert("Fix errors") : modal.style.display="flex"; };

  document.getElementById("confirmNo").onclick = ()=> modal.style.display="none";

  document.getElementById("confirmYes").onclick = () => {
    modal.style.display="none";
    loading.style.display="flex";
    const formData = new FormData(form);
    fetch(scriptURL, {method:"POST",body:formData})
      .then(r=>r.text()).then(msg=>{
        loading.style.display="none";
        alert(msg);
        generateMailto(form);
        form.reset();
      }).catch(e=>{loading.style.display="none"; alert("Submit failed: "+e.message)})
      .finally(()=>{submitBtn.disabled=false; submitBtn.innerText="Submit"});
    submitBtn.disabled=true; submitBtn.innerText="Submitting...";
  };

  // CREATE MAILTO LINK TO HOD
  function generateMailto(frm){
    const hod=frm.hod_mail.value, emp=frm.emp_name.value, lt=frm.leave_type.value,
          from=frm.from_date.value, to=frm.to_date.value, days=frm.taken_leave_count.value;
    const subject = `Leave Approval Request for ${emp}`,
          body = `
Dear ${frm.hod.value},

Please approve the leave request for ${emp}:

Type: ${lt}
From: ${from}
To: ${to}
Days: ${days}

Approve: https://script.google.com/macros/s/.../exec?action=approve&emp_code=${frm.emp_code.value}
Reject: https://script.google.com/macros/s/.../exec?action=reject&emp_code=${frm.emp_code.value}

Thank you.`;
    window.location.href = `mailto:${hod}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }
</script>

</body>
</html>
