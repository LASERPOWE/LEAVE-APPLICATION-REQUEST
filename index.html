<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Application Form</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      height: 100%;
      overflow: hidden;
    }
    video#bgVideo {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -1;
    }
    .form-container {
      padding: 30px;
      max-width: 700px;
      margin: auto;
      background: rgba(0, 0, 0, 0.8);
      margin-top: 20px;
      border-radius: 10px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #28a745;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .spinner-overlay {
      display: none;
      position: fixed;
      z-index: 999;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #authOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <video autoplay muted loop id="bgVideo">
    <source src="https://www.w3schools.com/howto/rain.mp4" type="video/mp4">
  </video>

  <div id="authOverlay">
    <div id="g_id_onload"
         data-client_id="64477546600-5r6mfqjqgo7mfddgvb94cfbml23nd67b.apps.googleusercontent.com"
         data-context="signin"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="sign_in_with"
         data-size="large"
         data-logo_alignment="left">
    </div>
  </div>

  <div class="spinner-overlay" id="loading"><div class="spinner"></div></div>

  <div class="form-container" style="display:none;">
    <form id="leaveForm">
      <label>EMP CODE</label>
      <input type="text" name="emp_code" id="emp_code" required>

      <label>EMP NAME</label>
      <select name="emp_name" id="emp_name" required></select>

      <label>HOD</label>
      <input type="text" name="hod" id="hod" readonly>

      <label>DESIG NAME</label>
      <input type="text" name="desig_name" id="desig_name" readonly>

      <label>DEPT NAME</label>
      <input type="text" name="dept_name" id="dept_name" readonly>

      <label>LEAVE TYPE</label>
      <select name="leave_type" id="leave_type" required>
        <option value="">--SELECT--</option>
        <option value="CL">CL</option>
        <option value="SL">SL</option>
        <option value="COFF">COFF</option>
      </select>

      <label>FROM DATE</label>
      <input type="date" name="from_date" id="from_date" required>

      <label>TO DATE</label>
      <input type="date" name="to_date" id="to_date" required>

      <label>REASON</label>
      <textarea name="reason" id="reason" rows="3" required></textarea>

      <label>TAKEN LEAVE COUNT</label>
      <input type="number" name="leave_count" id="leave_count" readonly>

      <input type="hidden" name="hod_mail" id="hod_mail">
      <input type="hidden" name="user_mail" id="user_mail">

      <button type="submit">Submit Leave Application</button>
    </form>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyOPuaoagCUk5BDCTgd74OGeWiRZpnpIt8WAl8tD3Efqj6qAqgzyCDqWfkqFeD9XAw4nw/exec";
    const form = document.getElementById("leaveForm");
    const empNameSelect = document.getElementById("emp_name");
    const loading = document.getElementById("loading");
    let matchedEmployees = [];

    function handleCredentialResponse(response) {
      const decoded = JSON.parse(atob(response.credential.split('.')[1]));
      const email = decoded.email;
      if (email) {
        localStorage.setItem("user_mail", email);
        document.getElementById("user_mail").value = email;
        document.querySelector(".form-container").style.display = "block";
        document.getElementById("authOverlay").style.display = "none";
      }
    }

    window.onload = () => {
      const email = localStorage.getItem("user_mail");
      if (email) {
        document.getElementById("user_mail").value = email;
        document.querySelector(".form-container").style.display = "block";
        document.getElementById("authOverlay").style.display = "none";
      }
    };

    document.getElementById("emp_code").addEventListener("blur", () => {
      const code = form.emp_code.value.trim();
      if (!code) return;
      loading.style.display = "flex";

      fetch(`${scriptURL}?emp_code=${code}`)
        .then(res => res.json())
        .then(data => {
          empNameSelect.innerHTML = '<option value="">--Select Employee--</option>';
          matchedEmployees = Array.isArray(data.employees) ? data.employees : [];

          const seen = new Set();
          matchedEmployees.forEach(emp => {
            if (!seen.has(emp.emp_name)) {
              const option = document.createElement("option");
              option.value = emp.emp_name;
              option.text = emp.emp_name;
              empNameSelect.appendChild(option);
              seen.add(emp.emp_name);
            }
          });

          loading.style.display = "none";
        })
        .catch(err => {
          console.error("Fetch error:", err);
          loading.style.display = "none";
        });
    });

    empNameSelect.addEventListener("change", () => {
      const selected = empNameSelect.value;
      const emp = matchedEmployees.find(e => e.emp_name === selected);
      if (emp) {
        form.hod.value = emp.hod || "";
        form.desig_name.value = emp.desig_name || "";
        form.dept_name.value = emp.dept_name || "";
        form.hod_mail.value = emp.hod_mail || "";
      }
    });

    document.getElementById("to_date").addEventListener("change", calculateLeaveCount);
    document.getElementById("from_date").addEventListener("change", calculateLeaveCount);

    function calculateLeaveCount() {
      const from = new Date(form.from_date.value);
      const to = new Date(form.to_date.value);
      if (from && to && to >= from) {
        const diff = Math.floor((to - from) / (1000 * 60 * 60 * 24)) + 1;
        form.leave_count.value = diff;
      } else {
        form.leave_count.value = "";
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      loading.style.display = "flex";

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          "Content-Type": "application/json"
        }
      }).then(res => res.text())
        .then(msg => {
          alert("Leave request submitted successfully.");
          form.reset();
          empNameSelect.innerHTML = '';
          loading.style.display = "none";
        }).catch(err => {
          alert("Error submitting form.");
          console.error(err);
          loading.style.display = "none";
        });
    });
  </script>
</body>
</html>
