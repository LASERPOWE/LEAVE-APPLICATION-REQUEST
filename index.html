<script>
  let leaveBalances = { CL: 0, SL: 0, COFF: 0 };

  document.getElementById('emp_code').addEventListener('blur', () => {
    const empCode = document.getElementById('emp_code').value.trim();
    if (!empCode) return;

    // Fetch employee details from Web App (GET)
    fetch("https://script.google.com/macros/s/AKfycby4fCr8tZTN63ypNxGUeparjkR8BhAYwNRde_LaZ-7XafTPKABGWagdEza8YoPOrrWuUA/exec?emp_code=" + encodeURIComponent(empCode))
      .then(res => res.json())
      .then(data => {
        if (data && data.emp_name) {
          document.getElementById('emp_name').value = data.emp_name;
          document.getElementById('desig_name').value = data.desig_name;
          document.getElementById('dept_name').value = data.dept_name;
          document.getElementById('hod').value = data.hod;
          document.getElementById('hod_mail').value = data.hod_mail;

          leaveBalances = {
            CL: parseInt(data.cl || 0),
            SL: parseInt(data.sl || 0),
            COFF: parseInt(data.coff || 0)
          };

          document.getElementById('cl_balance').innerText = leaveBalances.CL;
          document.getElementById('sl_balance').innerText = leaveBalances.SL;
          document.getElementById('coff_balance').innerText = leaveBalances.COFF;
          document.getElementById('total_balance').innerText =
            leaveBalances.CL + leaveBalances.SL + leaveBalances.COFF;
        } else {
          alert("Employee not found!");
        }
      })
      .catch(err => {
        alert("Error fetching employee details.");
        console.error(err);
      });
  });

  document.getElementById('from_date').addEventListener('change', calculateLeaveDays);
  document.getElementById('to_date').addEventListener('change', calculateLeaveDays);
  document.getElementById('leave_type').addEventListener('change', calculateLeaveDays);

  function calculateLeaveDays() {
    const from = new Date(document.getElementById('from_date').value);
    const to = new Date(document.getElementById('to_date').value);
    const errorDiv = document.getElementById("error");

    if (from && to && to >= from) {
      const diff = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
      document.getElementById('taken_leave_count').value = diff;

      const selectedType = document.getElementById('leave_type').value;
      if (selectedType && leaveBalances[selectedType] !== undefined) {
        if (diff > leaveBalances[selectedType]) {
          errorDiv.innerText = `Insufficient balance for ${selectedType}. Only ${leaveBalances[selectedType]} available.`;
        } else {
          errorDiv.innerText = '';
        }
      }

    } else {
      document.getElementById('taken_leave_count').value = '';
      errorDiv.innerText = '';
    }
  }

  // Submit the form (POST to Web App)
  document.getElementById("leaveForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const errorText = document.getElementById("error").innerText;
    if (errorText) {
      alert("Cannot submit: " + errorText);
      return;
    }

    const formData = Object.fromEntries(new FormData(this).entries());

    // Rename key from taken_leave_count to leave_count to match your format
    formData.leave_count = formData.taken_leave_count;
    delete formData.taken_leave_count;

    fetch("https://script.google.com/macros/s/AKfycby4fCr8tZTN63ypNxGUeparjkR8BhAYwNRde_LaZ-7XafTPKABGWagdEza8YoPOrrWuUA/exec", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(formData)
    })
      .then(res => res.text())
      .then(response => {
        alert("Form submitted successfully!");
        document.getElementById("leaveForm").reset();
        document.getElementById("cl_balance").innerText = "-";
        document.getElementById("sl_balance").innerText = "-";
        document.getElementById("coff_balance").innerText = "-";
        document.getElementById("total_balance").innerText = "-";
        document.getElementById("error").innerText = "";
      })
      .catch(err => {
        alert("Error submitting form.");
        console.error(err);
      });
  });
</script>
