<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Application Form</title>

  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "995677134206-i3n2k43cvsr48ngjb6t69s7tsr0sivpj.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        auto_select: true,
        cancel_on_tap_outside: false,
      });

      google.accounts.id.prompt((notification) => {
        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
          document.getElementById("login-overlay").style.display = "flex";
        }
      });
    };

    function handleCredentialResponse(response) {
      const decoded = parseJwt(response.credential);
      const email = decoded.email;
      if (email) {
        document.getElementById("user_mail").value = email;
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("form-section").style.display = "block";
      }
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = decodeURIComponent(atob(base64Url).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(base64);
    }

    function manualSignIn() {
      google.accounts.id.prompt();
    }
  </script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    video.bg-video {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -1;
    }

    .form-container {
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      margin: 50px auto;
      width: 90%;
      max-width: 600px;
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .loading-spinner::after {
      content: '';
      width: 80px;
      height: 80px;
      border: 10px solid white;
      border-top: 10px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #login-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.9);
      color: white;
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #login-overlay button {
      margin-top: 20px;
      background: white;
      color: #1a73e8;
      font-size: 18px;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #form-section {
      display: none;
    }

    .balances {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .balances span {
      font-weight: bold;
    }

    #confirmModal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20000;
    }

    #confirmModalContent {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
    }

    #confirmModalContent button {
      margin: 10px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>

<!-- Background Video -->
<video autoplay muted loop class="bg-video">
  <source src="https://cdn.pixabay.com/vimeo/913471700/fabric-183896.mp4?width=1920&hash=135857f41847df7a1f3b8dd52947c6d1f7d4ad12" type="video/mp4">
</video>

<!-- Login Overlay -->
<div id="login-overlay">
  <h2>Please sign in to access the leave form</h2>
  <button onclick="manualSignIn()">Sign in with Google</button>
</div>

<!-- Spinner -->
<div class="loading-spinner" id="spinner"></div>

<!-- Confirmation Modal -->
<div id="confirmModal">
  <div id="confirmModalContent">
    <p>Are you sure you want to submit the leave request?</p>
    <button onclick="submitForm()">Yes, Submit</button>
    <button onclick="document.getElementById('confirmModal').style.display='none'">Cancel</button>
  </div>
</div>

<!-- Leave Form Section -->
<div id="form-section">
  <div class="form-container">
    <h2>Leave Application Form</h2>
    <form id="leaveForm">
      <input type="text" placeholder="EMP_CODE" id="emp_code" name="emp_code" required><br><br>

      <div class="balances">
        <span id="cl_bal">CL: 0</span>
        <span id="sl_bal">SL: 0</span>
        <span id="coff_bal">COFF: 0</span>
        <span id="total_bal">TOTAL: 0</span>
      </div>

      <input type="text" id="emp_name" placeholder="EMP_NAME" name="emp_name" readonly><br><br>
      <input type="text" id="hod" placeholder="HOD" name="hod" readonly><br><br>
      <input type="text" id="desig_name" placeholder="DESIG_NAME" name="desig_name" readonly><br><br>
      <input type="text" id="dept_name" placeholder="DEPT_NAME" name="dept_name" readonly><br><br>

      <select name="leave_type" id="leave_type" required>
        <option value="">Select LEAVE TYPE</option>
        <option value="CL">CL</option>
        <option value="SL">SL</option>
        <option value="COFF">COFF</option>
      </select><br><br>

      <input type="date" id="from_date" required>
      <input type="date" id="to_date" required><br><br>

      <input type="text" id="reason" placeholder="REASON" required><br><br>
      <input type="number" id="leave_count" placeholder="TAKEN LEAVE COUNT" readonly><br><br>
      <input type="email" id="user_mail" name="user_mail" placeholder="USER MAIL" readonly><br><br>
      <input type="email" id="hod_mail" name="hod_mail" placeholder="HOD MAIL ID" readonly><br><br>

      <button type="submit">Submit</button>
    </form>
  </div>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbwo_9o4UxgcQfFxQtEHPb9351an-SoYQQ3d2CfeWh4v0Qr-BHHXzjtp9ccEGULNC_AfNw/exec';

const form = document.getElementById('leaveForm');
const spinner = document.getElementById('spinner');
const confirmModal = document.getElementById('confirmModal');

document.getElementById('emp_code').addEventListener('change', async function () {
  const code = this.value.trim();
  if (!code) return;
  spinner.style.display = 'flex';
  try {
    const res = await fetch(`${scriptURL}?emp_code=${code}`);
    const data = await res.json();
    document.getElementById('emp_name').value = data.emp_name || '';
    document.getElementById('hod').value = data.hod || '';
    document.getElementById('desig_name').value = data.desig_name || '';
    document.getElementById('dept_name').value = data.dept_name || '';
    document.getElementById('hod_mail').value = data.hod_mail || '';
    document.getElementById('cl_bal').textContent = `CL: ${data.cl || 0}`;
    document.getElementById('sl_bal').textContent = `SL: ${data.sl || 0}`;
    document.getElementById('coff_bal').textContent = `COFF: ${data.coff || 0}`;
    document.getElementById('total_bal').textContent = `TOTAL: ${data.total_leave || 0}`;
  } catch (err) {
    alert("Error fetching employee data");
  } finally {
    spinner.style.display = 'none';
  }
});

document.getElementById('from_date').addEventListener('change', calculateLeaveDays);
document.getElementById('to_date').addEventListener('change', calculateLeaveDays);

function calculateLeaveDays() {
  const from = new Date(document.getElementById('from_date').value);
  const to = new Date(document.getElementById('to_date').value);
  if (from && to && to >= from) {
    const count = Math.floor((to - from) / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('leave_count').value = count;
  } else {
    document.getElementById('leave_count').value = '';
  }
}

form.addEventListener('submit', (e) => {
  e.preventDefault();
  confirmModal.style.display = 'flex';
});

async function submitForm() {
  confirmModal.style.display = 'none';
  spinner.style.display = 'flex';

  const formData = {
    emp_code: form.emp_code.value,
    emp_name: form.emp_name.value,
    hod: form.hod.value,
    desig_name: form.desig_name.value,
    dept_name: form.dept_name.value,
    leave_type: form.leave_type.value,
    from_date: document.getElementById('from_date').value,
    to_date: document.getElementById('to_date').value,
    reason: document.getElementById('reason').value,
    leave_count: document.getElementById('leave_count').value,
    hod_mail: form.hod_mail.value,
    user_mail: form.user_mail.value
  };

  try {
    const res = await fetch(scriptURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    alert("Leave request submitted!");

    // Simulate email to HOD
    const subject = encodeURIComponent("Leave Approval Request");
    const body = encodeURIComponent(`Please approve or reject the leave.\n\nApprove: ✅\nReject: ❌`);
    window.open(`mailto:${formData.hod_mail}?subject=${subject}&body=${body}`);
    form.reset();
  } catch (err) {
    alert("Error submitting form");
  } finally {
    spinner.style.display = 'none';
  }
}
</script>

</body>
</html>
